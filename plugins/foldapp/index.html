<!DOCTYPE html>
<html>
<head>
  <meta name=viewport content="initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="FoldApp Interface for Airbitz" />
  <meta charset=utf-8 />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="css/core.css">
  <!-- Basic stylesheet -->
<link rel="stylesheet" href="vendors/owl-carousel/owl.carousel.css">
 <!-- Default Theme -->
<link rel="stylesheet" href="vendors/owl-carousel/owl.theme.css">

<style type="text/css">
	<!--
	.add-funds-header {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:16pt; color: #007aFF; height: 70px}
	.title-header     {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:16pt; color: #555555; padding-top: 10px; padding-bottom: 0px}
	.title-header-2   {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:16pt; color: #555555; padding-bottom: 5px}
	.card-number      {font-family: Courier, serif; font-size:11pt; color: #555555}
	.card-balance     {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:11pt; color: #555555; padding-top: 5px}
	.card-balance-amt {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:20pt; color: #555555; padding-bottom: 10px}
	.card-value       {font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:18pt; color: #555555; height: 50px}
	.collapsible-header {vert-align: middle}
	.buy-card         {
		background-color: #FFFFFF;
		-moz-border-radius: 10px;
		-webkit-border-radius: 10px;
		border: 1px solid #007aFF;
		color: #007aFF;
		padding-top: 3.5px;
		padding-bottom: 3.5px;
		padding-left: 9px;
		padding-right: 9px;
		font-family: Lato, Verdana, Arial, Helvetica, sans-serif; font-size:12pt;
	}
	-->
</style>

	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="css/materialize.css"  media="screen,projection"/>
<template id="how-it-works">
	<div class="step-1">
		<h5>Load</h5>
		<p>Visit your local <span class="brand-name">BRAND_NAME</span>. Select the card amount you want and confirm your payment.</p>
	</div>
	<div class="step-2">
		<h5>Pay</h5>
		<p>Place your order with the barista. Pay for your order by scanning the barcode on your phone.</p>
	</div>
	<div class="step-3">
		<h5>Enjoy</h5>
		<p>You’re done! Enjoy your coffee! If you have any trouble, please email <a href="mailto:support@airbitz.co?Subject=Need help with Fold">support@airbitz.co</a></p>
	</div>
</template>
<template id="card-template">
	<div class="item card gift-card">
		<div class="card-image">
			<div class="card-barcode"><div class="material-placeholder"><img class="barcode" src=""></div></div>
		</div>
		<div class="card-info-main card-content">
			<div class="card-number"></div>
			<div class="card-balance">Current Balance</div><i class="material-icons right activator card-info">info_outline</i>
			<div class="card-balance-amt"></div>
		</div>
		<div class="card-reveal valign-wrapper">
			<span class="card-title grey-text text-darken-4">Card Details<i class="material-icons card-close right">close</i></span>
			<a class="waves-effect btn center card-refund valign">Refund</a>
		</div>
	</div>
</template>
<!-- https://airbitz.co/go/wp-content/uploads/2015/12/download.png -->
<template id="add-template">
	<li class="collection-item avatar card-list">
		<span class="title"><h4 class="card-value" value=""></h4></span>
		<div class="secondary-content">
			<button type="button" class="buy-card btn-floating btn-large waves-effect waves-light green"><i class="material-icons medium">add</i></button>
		</div>
	</li>
</template>
</head>
<body>
	<div class="container-fluid">
	  	<center class="main">
	  		<header>
					<img class="brand-logo" src=""/>
					<div class="title-header">Spend Ƀitcoin at <span class="brand-name"></span></div>
					<div class="title-header-2">&amp; Save <span class="brand-discount"></span></div>
			</header>
			<main class="container-fluid">
			  	<div id="user-cards" class="owl-carousel owl-theme">
			  		
			  	</div>
			  	<div class="add-funds">
	  			<ul class="collapsible" data-collapsible="accordion">
	  				<li>
	  		  			<div class="collapsible-header active">
	  				        <div class="add-funds-header">Add Funds</div>
	  				    </div>
	  				    <div class="collapsible-body">
	  				    	<ul class="collection add-buttons">

	  				    	</ul>
	  				    </div>
	  		  		</li>
	  			</ul>
					  	<!-- <div class="row">
					  		<div class="col-md-12">
						  		<button type="button" value="5" class="btn btn-info btn-lg btn-add add-first">$5</button> 
						  		<button type="button" value="10" class="btn btn-info btn-lg btn-add add-second">$10</button> 
						  	</div>
						</div>
						<div class="row">
							<div class="col-md-12">
						  		<button type="button" value="25" class="btn btn-info btn-lg btn-add add-third">$25</button>
						  	</div>
						</div> -->
				</div>
			</main>
			<footer>
				<div class="container">
					<div class="row">
						<div class="col l6 s12">
							<h6>This service is provided by Fold Inc. For issues with gift card purchases and refunds, please contact support@foldapp.com. Please provide the following account ID to support: <span class="user-creds"></span></h6>
							<h6>This application is not affiliated with the <span class="brand-name"></span> Corporation</h6>
						</div>
					</div>
				</div>
			</footer>
	  	</center>
	</div>

  <script src="js/abc.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="js/materialize.min.js"></script>
  <script src="vendors/owl-carousel/owl.carousel.js" type="text/javascript"></script>
<script type="text/javascript">
var fold_api = "https://api.foldapp.com/v1/";
var brand = Airbitz.config.get("BRAND");
var api_token = Airbitz.config.get("API-TOKEN");

var brand_logo_urls = {
	"Starbucks":"https://airbitz.co/go/wp-content/uploads/2015/12/green-coffee-mug-128px.png", // Starbucks
	"Target":"https://airbitz.co/go/wp-content/uploads/2015/12/red-bulls-eye-128px.png" // Target
};
document.title = brand; // Set page's title to brand of gift card.

function toggleUi() {
	$(".fold-loading").css("display", "none");
	$(".main").css("display", "inline");
	setInterval(function() {
		user.resetCards(function() {});
	}, 5000);
}

function supportsTemplate() {
  return 'content' in document.createElement('template');
}

function supportsImports() {
  return 'import' in document.createElement('link');
}
if (supportsTemplate()) {
  Airbitz.ui.debugLevel(1,"Does support templates!");
} else {
  // Use old templating techniques or libraries.
  Airbitz.ui.debugLevel(1,"Does not support templates.");
}
if (supportsImports()) {
  // Good to go!
  Airbitz.ui.debugLevel(1,"Supports imports!");
} else {
  // Use other libraries/require systems to load files.
  Airbitz.ui.debugLevel(1,"Does not support imports.");
}

var createAddress = function(wallet, label, amountSatoshi, amountFiat,
                            category, notes, resolve, reject) {
    Airbitz.core.createReceiveRequest(wallet, {
      label: label,
      category: category,
      notes: notes,
      amountSatoshi: amountSatoshi,
      amountFiat: amountFiat,
      success: resolve,
      error: reject
    })
};

function updateWallet(wallet) {
	Account.abWallet = wallet;
}

function sRequest(url, json, handleReponse) {
	$.ajax({
    headers: {
        'Accept' : 'application/json',
        'Content-Type' : 'application/json',
        'X-CFC-PartnerToken': api_token,
    },
    'type' : 'POST',
    'url' : url,
    'data' : JSON.stringify(json),
    'dataType': 'json',
    success : function(response) {
    	handleReponse(response);
    }
}).fail(function(xhr, textStatus, error) {
	Airbitz.ui.debugLevel(1,"There was an error. Status: " + xhr.status);
	Airbitz.ui.debugLevel(1,xhr.Message);
});
}

var Account = {
	exists: $.Deferred(),
	logged_in: $.Deferred(),
	all_cards: [],
	owl: $("#user-cards"),
	owlSet: false, // Owl set
	create: function() {
		Airbitz.ui.debugLevel(1,"Creating user.");
		url = fold_api + "users";
  	newAcc = {"users": [{
  	  "random_username": true,
  	  "random_password": true
  	}]}
	sRequest(url, newAcc, function(r) {
		//Airbitz.ui.debugLevel(1,r);
		Account.username = r['users'][0]['username'];
		Account.pass = r['users'][0]['password'];
		Account.creds = {"users": [{
		  "username": Account.username,
		  "password": Account.pass
		}]};
		Airbitz.core.writeData("fold-username", Account.username);
		Airbitz.core.writeData("fold-pass", Account.pass);
		Account.exists.resolve();
	});
	},
	login: function() {
		url = fold_api + "my/session";
		Airbitz.ui.debugLevel(1,Account.creds);
		sRequest(url, Account.creds, function(r) {
			//Airbitz.ui.debugLevel(1,"Logging in" + JSON.stringify(r));
			Account.logged_in.resolve(r);
		});
	},
	updateBalance: function() {
		this.getInfo("balances?currency=USD", function(balances) {
			Airbitz.ui.debugLevel(1,"Balance: " + JSON.stringify(balances["balances"][0]["amount"]));
			$(".balance-amt").text("$" + balances["balances"][0]["amount"]);
		});
	},
	updateWAddr: function(addr, updated) { // Set the default BTC address
		var withdraw_url = fold_api + "my/default_withdraw_addresses";
		Airbitz.ui.debugLevel(1,"Setting default address to: " + addr.toString());
		newAddr = {"default_withdraw_addresses": [{
			  "currency": "BTC",
			  "default_address": [{
			    "address": addr.toString(),
			    "address_type": "crypto"
			  }]
		}]};
		Airbitz.ui.debugLevel(1,withdraw_url);
		Airbitz.ui.debugLevel(1,newAddr);
		sRequest(withdraw_url, newAddr, function(response) {
			Airbitz.ui.debugLevel(1,"Updated default_withdraw_address");
			updated();
		});
	},
	resetCards: function(doneUpdating) {
		Airbitz.ui.debugLevel(1,"Resetting cards.");
		Account.getCards(function(cards) {
			Account.updateCards(cards, doneUpdating);
		});
	},
	clearOwl: function() {
		if(Account.owlSet) {
			Airbitz.ui.debugLevel(1,"Clearing Owl");
			for(var o = 0; o < Account.owl.data("owlCarousel").owl.owlItems.length; o ++) {
				Account.owl.data('owlCarousel').removeItem();
			}
		} else { Account.owlSet = true; }
	},
	getCards: function(c) {
		user.getInfo("cards", function(all_card_info) {
			Airbitz.ui.debugLevel(1,"User's cards: " + JSON.stringify(all_card_info));
			c(all_card_info["cards"]);
		});
	},
	updateCards: function(cards, doneUpdating) { // Updates the UI with cards the user has purchased
		Airbitz.ui.debugLevel(1,"Updating " + cards.length + " cards.");
		if(!cards.length > 0) {
			if(Account.diffCs(cards) || (!Account.owlSet)) {
				Airbitz.ui.debugLevel(1,"No cards. New acc!");
				if(typeof Account.owl.data("owlCarousel").owl === 'undefined') {
					Account.setDummyC();
				} else if(Account.owl.data("owlCarousel").owl.owlItems.length > 0) {
					Account.setDummyC();
				}
			}
		} else { // There's at least one card
			if(Account.diffCs(cards)) {
				Account.clearOwl();
				Account.all_cards = [];
				for(numOfCards in cards) {
					card = new Card(
						cards[numOfCards]["id"],
						cards[numOfCards]["code"][0],
						cards[numOfCards]["balance"][0]["amount"],// e.g. $5
						cards[numOfCards]["refundable"]
					);
					Account.all_cards[numOfCards] = card;
					var card_html = document.querySelector('#card-template').content;
					if(!card.bal == 0) {
						card_html.querySelector(".card-barcode").innerHTML = "<img class=\"barcode \" src=\"" + fold_api + "my/cards/" + card.id + "/barcode/png" + "\">";
						card_html.querySelector(".card-balance-amt").innerText = card.bal;
						card_html.querySelector(".card-balance-amt").setAttribute("card", card.id);
						card_html.querySelector(".card-number").innerText = card.num;
						if(card.isRefundable) {
							card_html.querySelector(".card-info").innerText = "info_outline"; // Make sure the info button shows up.
						} else { 
							card_html.querySelector(".card-info").innerText = "";
						}
						
						Airbitz.ui.debugLevel(1,"Adding card: " + numOfCards + " card info: " + cards[numOfCards]);
						Account.owl.data('owlCarousel').addItem(document.importNode(card_html, true));
						//document.querySelector("#user-cards").appendChild( document.importNode(card_html, true) );
					}
				}
			}
		}
		$('.materialboxed').materialbox();
		$(".card-refund").click(function() {
			Airbitz.ui.debugLevel(1,"Refunding button");
			var thisCardId = $(this).parent().parent().children(".card-info-main").children(".card-balance-amt").attr("card");
			Airbitz.ui.debugLevel(1,"This card: " + thisCardId);
			var thisCard = Account.getCardById(thisCardId);
			thisCard.refund();
		});
	doneUpdating();
	},
	diffCs: function(cards) { // Has different cards?
		var match = 0;
		Airbitz.ui.debugLevel(1,cards.length);
		Airbitz.ui.debugLevel(1,Account.all_cards.length);
		if(cards.length != Account.all_cards.length) {
			return true;
		}
		for(fcard in cards) {
			for(card in Account.all_cards) {
				if(cards[fcard]["id"] == Account.all_cards[card].id) {
					match++;
					Airbitz.ui.debugLevel(1,"balances ares: " + cards[fcard]["balance"][0]["amount"]);
					Airbitz.ui.debugLevel(1,Account.all_cards[card].bal);
					if(cards[fcard]["balance"][0]["amount"] != Account.all_cards[card].bal) {
						return true;
					}
				}
			}
		}
		if(match != cards.length) {
			return true;
		}
		return false;
	},
	setDummyC: function() {
		var card_html = document.querySelector('#card-template').content;
		card_html.querySelector(".card-barcode").innerHTML = "<img class=\"barcode barcode-inactive\" src=\"https://airbitz.co/go/wp-content/uploads/2015/12/download.png\"/>";
		card_html.querySelector(".card-balance-amt").innerText = "$0.00";
		card_html.querySelector(".card-number").innerText = "6666 8888 4444 0000";
		card_html.querySelector(".card-info").innerText = "";
		Account.clearOwl();
		Account.owl.data('owlCarousel').addItem( document.importNode(card_html, true) );
	},
	getCardById: function(cardId) {
		var cardFromId = Account.all_cards.filter(function( obj ) {
		  return obj.id == cardId;
		});
		return cardFromId[0];
	},
	listCards: function(doneListing) { // Updates the UI with cards avaliable to purchase from Fold.
		this.getInfo("brands", function(cards_avil) {
			Airbitz.ui.debugLevel(1,JSON.stringify(cards_avil) );
			var all_brands = cards_avil["brands"];
			var brands_cards = "";
			for(numOfbrands in all_brands) {
				if(all_brands[numOfbrands]["id"] == brand) {
					brands_cards = all_brands[numOfbrands];
					break;
				}
			}
			Airbitz.ui.debugLevel(1,JSON.stringify(brands_cards["card_values"]));
			user.getBal(function(total_bal) {
				user.total_bal = total_bal;
                if (brands_cards["soft_max_total"] && brands_cards["soft_max_total"].length > 0) {
                    var maxBal = parseInt(brands_cards["soft_max_total"][0]["amount"]);
                } else {
                    var maxBal = 0;
                }
				Airbitz.ui.debugLevel(1,"User bal: " + user.total_bal);
				Airbitz.ui.debugLevel(1,"Max: " + maxBal);
				if(maxBal >= user.total_bal) {
					var card_vals = brands_cards["card_values"];
					document.querySelector(".add-buttons").innerHTML = "";
					for(numOfVals in card_vals) {
						Airbitz.ui.debugLevel(1,"Listing card " + numOfVals);
						var add_html = document.querySelector('#add-template').content;
						add_html.querySelector(".card-value").setAttribute("value", card_vals[numOfVals]["amount"]);
						add_html.querySelector(".card-value").innerText = card_vals[numOfVals]["formatted"]["all_decimal_places"];
						document.querySelector(".add-buttons").appendChild(document.importNode(add_html,true));
					}
					$(".buy-card").click(function() {
				  		user.purchaseCard($(this).parent().parent().find(".card-value").attr("value"));
					});
				}
				doneListing();
			});
		}, "");
	},
	logRefunds: function() {
		Account.getInfo("refunds", function(refunds) {
			console.log(JSON.stringify(refunds));
			Airbitz.ui.debugLevel(1,JSON.stringify(refunds));
		});
	},
	getInfo: function(info, handleResponse, root) {
		root = typeof root !== 'undefined' ? root : "my/";
		$.get(fold_api + root + info).done(function(response) {
			handleResponse(response);
		});
	},
	getBal: function(handleResponse) { // Get total balance of user. Return 0 if user doesn't have bal.
		this.getInfo("balances?currency=USD", function(balances) {
			try {
				handleResponse(balances["balances"][0]["amount"]);
			}
			catch(err) {
				handleResponse(0);
			}
		});
	},
	purchaseCard: function(denomination, brand_id) {
		brand_id = typeof a !== 'undefined' ? a : brand;
		newOrder = { "orders": [{
	    "brand_id": String(brand_id),
	    "value": { "amount": String(denomination), "currency": "USD" },
	    "price": { "currency": "BTC" },
	    "approved": true
	  }],
	  "cancel_all_others": true
	}
		url = fold_api + "my/orders";
		Airbitz.ui.debugLevel(1,"Getting new order");
		sRequest(url, newOrder, function(r) {
			Airbitz.ui.debugLevel(1,"Order: " + JSON.stringify(r));
			amt = (r["orders"][0]["price"]["amount"] * 100000000);
			toAddr = r["orders"][0]["payment"][0]["address"];
			Airbitz.ui.debugLevel(1,"Spending " + amt + " from wallet: " + user.abWallet + " to: " + toAddr);
			Airbitz.ui.debugLevel(1,"Fiat amt: " + denomination)
			if (brand == "Starbucks") {
				categoryString = 'Expense:Coffee Shops'
			} else if (brand == "Target") {
				categoryString = 'Expense:Shopping'
			}
			Airbitz.core.requestSpend(Account.abWallet,
				toAddr, amt, denomination, {
	        	label: brand,
	        	category: categoryString,
	        	notes: brand + " $" + String(denomination) + " gift card.",
	        	success: function(rawtx) {
	        		Airbitz.ui.showAlert("Cool", "If you sent, your " + brand + " card should appear shortly.");
	        		Airbitz.ui.debugLevel(1,"Funds were sent.");
	        	},
	        	error: function() {
	        		Airbitz.ui.showAlert("Unable to send funds.", "Funds weren't sent");
	        		Airbitz.ui.debugLevel(1,"Funds were not sent.");
	        	}
	        });
		});
	},
	approveOrder: function(order_id) { // Manually Approve an order
		cOrder = {"orders": [{
	  				"id": String(order_id),
	  				"approved": true
				}]}
		sRequest(fold_api + "my/orders", cOrder, function(r) {
			Airbitz.ui.debugLevel(1,"Approving order");
			//Airbitz.ui.debugLevel(1,r);
		});
	}
}

function Card(id, num, bal, isRefundable) {
	isRefundable = typeof isRefundable !== 'undefined' ? isRefundable : false;
	this.id = id;
	this.num = num;
	this.bal = bal;
	this.isRefundable = isRefundable;
}

Card.prototype.ping = function() { // Tell Fold we need to check this balance to see if the user has spent it.
	var url = fold_api + "my/cards/" + this.id + "/ping";
	$.post(url);
}

Card.prototype.refund = function() {
	if(this.isRefundable) {
        Airbitz.ui.showAlert('', 'Refunding card...', {'showSpinner': true}); 
		url = fold_api + "my/refunds";
		thisCard = this;
		Airbitz.ui.debugLevel(1,"Refunding card " + this.id + " amount: " + this.bal);
		refund = {"refunds": [{
			  "card_id": this.id
		}]};
		createAddress(Account.abWallet, "Fold", 0, 0, "Expense:Coffee Shops", "Refunded " + brand + " gift card.", 
			function(data) {
				Account.updateWAddr(data["address"], function() {
					sRequest(url, refund, function(response) {
						Airbitz.ui.showAlert("Card Refunded", "Card Refunded. Please allow several minutes for refund.");
						Airbitz.ui.debugLevel(1,response);
						Airbitz.ui.debugLevel(1,"Done refunding!");
					});
				});
			}, function(data) {
                Airbitz.ui.showAlert("Card Refunded", "Error refunding card. Please try again later.");
				Airbitz.ui.debugLevel(1,data);
			});
    } else {
        Airbitz.ui.showAlert('', 'Card is not refundable');
    }
}

Card.prototype.remove = function() { // Remove card from UI
	if(this.bal == 0) {

	}
}

Card.prototype.mockBal = function(bal) {
	var url = fold_api + "my/mock/cards";
	var thisCard = this;
	$.post(url, 
	{"cards": [{
	  "id": thisCard.id.toString(),
	  "balance_amount": bal.toString()
	}]}
	).done(function() {
		Airbitz.ui.debugLevel(1,"Done mocking " + thisCard.id + " balance to: " + bal);
	});
}

// Main
var user = Object.create(Account);

Airbitz.core.setWalletChangeListener(updateWallet);
//Airbitz.core.clearData(); fold-2015-11-18-JszcOVECE0iHn5
Account.username = Airbitz.core.readData("fold-username");
Account.pass = Airbitz.core.readData("fold-pass");
Airbitz.ui.showAlert('', 'Loading account...', {
    'showSpinner': true
});

if(!(typeof Account.username === 'undefined' || Account.username == null)) {
	Account.creds = {"users": [{
		  "username": Account.username,
		  "password": Account.pass
		}]};
	Airbitz.ui.debugLevel(1,"User pulled from memory.");
	user.exists.resolve();
} else {
	user.create();
}
$.when(user.exists).done(function(data) {
	user.login();
});
$(function() {
	$.when(user.logged_in).done(function(data) {
		Airbitz.ui.debugLevel(1,"Logged in");
		Account.owl.owlCarousel({ // Activate owl Carousel for cards.
		    //navigation : true, // Show next and prev buttons
		    slideSpeed : 300,
		    paginationSpeed : 400,
		    singleItem:true
		
		    // "singleItem:true" is a shortcut for:
		    // items : 1,
		    // itemsDesktop : false,
		    // itemsDesktopSmall : false,
		    // itemsTablet: false,
		    // itemsMobile : false
		});
		Account.logRefunds();
		Airbitz.core.selectedWallet({
		      success: updateWallet,
		      error: function() {
		      	Airbitz.ui.debugLevel(1,"Could not get selected wallet");
		      }
		    });
		Airbitz.ui.debugLevel(1,"Updating UI");
		user.listCards(function() { // Start getting avaliable cards for sale.
			user.getCards(function(cards) {
				user.updateCards(cards,function() {
				toggleUi();
                Airbitz.ui.hideAlert();
				});
			});
			// user.updateBalance();
		}); 
		user.getInfo("profile", function(response) {
			//Airbitz.ui.debugLevel(1,response);
			//Airbitz.ui.debugLevel(1,response["logged_in"]);
			user.getInfo("orders", function(response) {
				//Airbitz.ui.debugLevel(1,response);
			});
		// Done loading.
		});
	});
	// UI stuff
	Airbitz.ui.debugLevel(1,"logo: " + brand_logo_urls[brand]);
	$(".brand-name").text(brand);
	if (brand == "Starbucks") {
		brand_discount = "20%"
	} else if (brand == "Target") {
		brand_discount = "~15%"
	}

	$(".brand-discount").text(brand_discount);
	$(".brand-logo").attr("src", brand_logo_urls[brand]);
	$(".user-creds").text("Username: " + Account.username  + " Pass: " + Account.pass);
});

</script>
</body>
</html>


